import configparser
import sys
import tensorflow as tf
config = configparser.ConfigParser()
config.read('.env')
module_path = config['global']['MODULE_PATH']
sys.path.append(module_path)

from training_models.multistage_regression_model import MultiStageLSTM
from training_models.classifier import ThroughputClassifier
from training_models.baseline_regression_model import BaselineLSTM

class optimizedBaseline(BaselineLSTM):
    def build_model(self):
        self._model.add(tf.compat.v1.keras.layers.CuDNNLSTM(256, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.compat.v1.keras.layers.CuDNNLSTM(112,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.compat.v1.keras.layers.CuDNNLSTM(96,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.2))
        self._model.add(tf.keras.layers.Dense(40, activation="relu"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(40, activation="relu"))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.Dense(48, activation="relu"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=0.0001), loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()


class optimizedClassifierModel(ThroughputClassifier):
    def build_model(self, loss="categorical_crossentropy"):
        self._model.add(tf.keras.layers.LSTM(96, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.2))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.3))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(64, activation="relu"))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Dense(32, activation="relu"))
        self._model.add(tf.keras.layers.Dense(3, name="OUT_{}".format(self._model_name), activation="softmax"))
        self._model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=0.0001), loss=loss, metrics=["accuracy"])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()


class optimizedLowRegressionModel(MultiStageLSTM):
    def build_model(self):
        epsilon = self.compute_epsilon()
        self._model.add(tf.keras.layers.LSTM(96, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(48,return_sequences=True))
        self._model.add(tf.keras.layers.LSTM(48,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(48,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer="adam", loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()


class optimizedMediumRegressionModel(MultiStageLSTM):
    def build_model(self):
        epsilon = self.compute_epsilon()
        self._model.add(tf.keras.layers.LSTM(96, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.3))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(0.1))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()


class optimizedHighRegressionModel(MultiStageLSTM):
    def build_model(self):
        epsilon = self.compute_epsilon()
        self._model.add(tf.keras.layers.LSTM(96, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.3))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(0.1))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=0.001), loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()