import configparser
import sys
import tensorflow as tf
config = configparser.ConfigParser()
config.read('project.env')
module_path = config['global']['MODULE_PATH']
sys.path.append(module_path)

from training_models.multistage_regression_model import MultiStageLSTM
from training_models.classifier import ThroughputClassifier
from training_models.baseline_regression_model import BaselineLSTM


class Baseline3Mb(BaselineLSTM):
    def build_model(self):
        self._model.add(tf.keras.layers.LSTM(128, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(96,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(64,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(24, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer="adam", loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()

class MultistageRegression3Mb(MultiStageLSTM):
    def build_model(self):
        self._model.add(tf.keras.layers.LSTM(56, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(48,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(36,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(36,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer="adam", loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()

class ClassifierModel3Mb(ThroughputClassifier):
    def build_model(self, loss="categorical_crossentropy"):
        self._model.add(tf.keras.layers.LSTM(56, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(48,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(36,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.LSTM(36,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.2))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(3, name="OUT_{}".format(self._model_name), activation="softmax"))
        self._model.compile(optimizer="adam", loss=loss, metrics=["accuracy"])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()

class MultistageRegression1_5Mb(MultiStageLSTM):
    def build_model(self):
        self._model.add(tf.keras.layers.LSTM(48, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(32,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(24,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(self._train_y.shape[1], name="OUT_{}".format(self._model_name)))
        self._model.compile(optimizer="adam", loss="mse", metrics=[tf.keras.metrics.MeanAbsoluteError()])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()

class ClassifierModel1_5Mb(ThroughputClassifier):
    def build_model(self, loss="categorical_crossentropy"):
        self._model.add(tf.keras.layers.LSTM(48, input_shape=(self._train_x.shape[1], self._train_x.shape[2]), return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.4))
        self._model.add(tf.keras.layers.LSTM(32,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(.3))
        self._model.add(tf.keras.layers.LSTM(24,return_sequences=True))
        self._model.add(tf.keras.layers.Dropout(0.4))
        self._model.add(tf.keras.layers.Flatten())
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dense(16, activation="sigmoid"))
        self._model.add(tf.keras.layers.Dropout(.1))
        self._model.add(tf.keras.layers.Dense(3, name="OUT_{}".format(self._model_name), activation="softmax"))
        self._model.compile(optimizer="adam", loss=loss, metrics=["accuracy"])
        self._model.summary()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        self.set_input_shape()
        self.set_output_shape()